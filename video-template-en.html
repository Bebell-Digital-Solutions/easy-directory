<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouTube Video Directory</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="icon" href="https://bucket.mlcdn.com/a/3336/3336910/images/efd70bdbad93d8089105b519d602a6eccbfa84bf.png">
    <style>
        :root {
            --primary: #DF1783;
            --primary-light: #f8a4d4;
            --secondary: #2d3748;
            --accent: #4fd1c5;
            --text: #2d3748;
            --text-light: #a0aec0;
            --bg: #f7fafc;
            --card-bg: #ffffff;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --border-color: #e2e8f0;
        }
        .dark-mode {
            --text: #f7fafc;
            --text-light: #a0aec0;
            --bg: #1a202c;
            --card-bg: #2d3748;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.4), 0 2px 4px -1px rgba(0, 0, 0, 0.2);
            --border-color: #4a5568;
        }
        
        html { 
            box-sizing: border-box; 
            overflow-x: hidden; 
            scroll-behavior: smooth;   
        }

        
        *, *:before, *:after { 
            box-sizing: inherit; 
             margin: 0;
            padding: 0;
        }

        
        body {
            margin: 0;
            padding-top: 200px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            transition: background-color 0.3s, color 0.3s;
        }

        
        .container { max-width: 1400px; margin: 0 auto; padding: 2rem 4rem; margin-bottom: 250px; }
        .top-menu-bar {
            position: fixed;
            top: 2rem;
            left: 50%;
            transform: translateX(-50%);
            width: calc(100% - 2rem);
            max-width: 1400px;
            z-index: 1100;
            background-color: var(--card-bg);
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 0 1.5rem;
        }
        
        
        .top-menu-content { height: 80px; display: flex; align-items: center; justify-content: space-between; }
        .logo-container { display: flex; align-items: center; gap: 1rem; }
        #appLogo { height: 40px; max-width: 150px; object-fit: contain; }
        #appBrandNameDisplay { font-size: 1.5rem; font-weight: 600; color: var(--text); }
        .top-menu-actions { display: flex; align-items: center; gap: 1rem; }
        .fab {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--bg);
            color: var(--text);
            border: 1px solid var(--border-color);
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .fab:hover { background-color: var(--border-color); }
        .header { text-align: center; margin-bottom: 2rem; }
        .header h1 { font-size: 2.8rem; color: var(--primary); margin-bottom: 0.5rem; }
        .header p { font-size: 1.2rem; color: var(--text-light); }
        .controls-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
            gap: 1.5rem;
            margin-bottom: 2.5rem;
            padding: 1.3rem;
            background-color: var(--card-bg);
            border-radius: 12px;
            box-shadow: var(--shadow);
            max-width: 800px;
            width: 100%;
            margin-left: auto;
            margin-right: auto;
        }
        .search-bar { position: relative; flex-grow: 1; max-width: 700px; }
        .search-bar input { width: 100%; padding: 12px 20px 12px 45px; border-radius: 30px; border: 1px solid var(--border-color); background-color: var(--bg); color: var(--text); font-size: 1rem; transition: border-color 0.3s; }
        .search-bar input:focus { outline: none; border-color: var(--primary); }
        .search-bar i { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: var(--text-light); }
        .btn { background-color: var(--primary); color: white; border: none; padding: 12px 24px; border-radius: 30px; cursor: pointer; font-weight: 600; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; gap: 8px; text-decoration: none; text-align: center; }
        .btn.btn-danger { background-color: #e53e3e; }
        .btn:hover { opacity: 0.85; transform: translateY(-2px); }
        .tag-filters { text-align: center; margin-bottom: 2.5rem; }
        .tag-filter { background-color: transparent; color: var(--text-light); border: 1px solid var(--border-color); padding: 8px 16px; margin: 5px; border-radius: 20px; cursor: pointer; transition: all 0.3s ease; }
        .tag-filter:hover, .tag-filter.active { background-color: var(--primary); color: white; border-color: var(--primary); }
        #showMoreTags { background: none; border: none; color: var(--primary); cursor: pointer; font-weight: 600; padding: 8px; margin-top: 10px; display: block; margin-left: auto; margin-right: auto; }
        .video-section { margin-bottom: 4rem; }
        .section-header { margin-bottom: 2rem; text-align: center; }
        .section-header h2 { font-size: 2.2rem; margin-bottom: 0.5rem; }
        .section-header p { font-size: 1.1rem; color: var(--text-light); }
        .grid-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 2rem; }
        .card { background-color: var(--card-bg); border-radius: 12px; overflow: hidden; box-shadow: var(--shadow); transition: transform 0.3s ease, box-shadow 0.3s ease; animation: fadeIn 0.5s ease forwards; position: relative; }
        .card:hover { transform: translateY(-5px); }
        .card-admin-controls { position: absolute; top: 10px; right: 10px; z-index: 5; display: none; gap: 8px; }
        body.admin-logged-in .card-admin-controls { display: flex; }
        .admin-btn { background-color: rgba(0,0,0,0.6); color: white; border: none; width: 30px; height: 30px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .admin-btn:hover { background-color: var(--primary); }
        .thumbnail { position: relative; cursor: pointer; aspect-ratio: 16 / 9; background-color: #e2e8f0; }
        .thumbnail img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.5s ease; }
        .card:hover .thumbnail img { transform: scale(1.05); }
        .play-button { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 60px; height: 60px; background: rgba(223, 23, 131, 0.8); border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: all 0.3s ease; opacity: 0; }
        .card:hover .play-button { opacity: 1; }
        .play-button i { color: white; font-size: 20px; }
        .content { padding: 1.2rem; }
        .title { font-size: 1.1rem; font-weight: 600; margin-bottom: 0.8rem; color: var(--text); }
        .description { color: var(--text-light); font-size: 0.9rem; margin-bottom: 1rem; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; }
        .tags { display: flex; flex-wrap: wrap; gap: 0.5rem; }
        .tag { background-color: var(--primary); color: white; padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 500; }
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.9); display: flex; align-items: center; justify-content: center; z-index: 1000; opacity: 0; visibility: hidden; transition: all 0.3s ease; overflow-y: auto; }
        .overlay.active { opacity: 1; visibility: visible; }
        .video-container { width: 80%; max-width: 900px; position: relative; padding: 2rem 0; }
        .video-wrapper { position: relative; padding-bottom: 56.25%; height: 0; margin-bottom: 1rem; }
        .video-wrapper iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: none; border-radius: 8px; }
        .close-btn { position: absolute; top: 0; right: 0; color: white; background: none; border: none; font-size: 2rem; cursor: pointer; }
        #ctaButton { display: none; width: 100%; margin: 1rem 0 0; }
        .modal { position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); display: flex; justify-content: center; align-items: center; opacity: 0; visibility: hidden; transition: all 0.3s ease; }
        .modal.active { opacity: 1; visibility: visible; }
        .modal-content { background-color: var(--card-bg); padding: 2rem; border-radius: 12px; width: 90%; max-width: 500px; position: relative; box-shadow: 0 10px 25px rgba(0,0,0,0.2); max-height: 90vh; overflow-y: auto; }
        .modal-close { position: absolute; top: 15px; right: 15px; font-size: 1.5rem; color: var(--text-light); cursor: pointer; }
        .modal-content h3 { margin-top: 0; margin-bottom: 1.5rem; text-align: center; }
        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 500; }
        .form-group input, .form-group textarea { width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 8px; background-color: var(--bg); color: var(--text); }
        .form-group textarea { resize: vertical; min-height: 80px; }
        #login-error, #register-error { color: #e53e3e; text-align: center; margin-bottom: 1rem; display: none; }
        .form-group .field-instructions { font-size: 0.8rem; color: var(--text-light); margin-top: 0.5rem; }
        .form-group .field-instructions a { color: var(--primary); text-decoration: none; }
        .recommendations { display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 0.5rem; margin-bottom: 1rem; }
        .rec-btn { background-color: var(--bg); color: var(--text-light); border: 1px solid var(--border-color); padding: 4px 10px; border-radius: 20px; cursor: pointer; font-size: 0.8rem; transition: all 0.3s ease; }
        .rec-btn:hover { background-color: var(--primary-light); border-color: var(--primary-light); color: var(--primary); }
        .profile-pic-uploader { display: flex; flex-direction: column; align-items: center; gap: 1rem; margin-bottom: 1rem; }
        .profile-pic-preview { width: 120px; height: 120px; border-radius: 50%; border: 3px dashed var(--primary); display: flex; align-items: center; justify-content: center; cursor: pointer; background-size: cover; background-position: center; color: var(--text-light); }
        .profile-pic-preview i { font-size: 2rem; }
        .profile-pic-uploader input[type="file"] { display: none; }
        .profile-pic-uploader .btn { width: auto; padding: 8px 16px; font-size: 0.9rem; }
        .settings-profile { display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border-color); }
        .settings-profile img { width: 80px; height: 80px; border-radius: 50%; object-fit: cover; }
        .settings-profile h4 { margin: 0; font-size: 1.2rem; }
        .share-url-container { display: flex; align-items: center; gap: 0.5rem; background-color: var(--bg); padding: 8px; border-radius: 8px; }
        .share-url-container input { flex-grow: 1; border: none; background: transparent; color: var(--text); }
        .share-url-container button { background: none; border: none; cursor: pointer; color: var(--text-light); }
        .share-buttons { display: flex; justify-content: center; gap: 1rem; margin-top: 1rem; }
        .share-btn { font-size: 1.5rem; color: var(--text-light); text-decoration: none; transition: color 0.2s ease; }
        .share-btn:hover { color: var(--primary); }
        .notification-banner { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: var(--accent); color: var(--secondary); padding: 1.5rem 2.5rem; border-radius: 12px; box-shadow: var(--shadow); z-index: 3000; font-weight: 500; opacity: 0; visibility: hidden; transition: all 0.3s ease-in-out; }
        .notification-banner.show { opacity: 1; visibility: visible; }
        .footer { padding-top: 20px; text-align: center; font-size: 12px; width: 100%; margin: 2rem auto 0; border-top: 2px solid #4a5568; color: #a0aec0; }
        .footer .legal-link, .footer .bebell-link { color: #a0aec0; }
        .footer .legal-link:hover, .footer .bebell-link:hover { color: var(--primary); }
        .social-links-container { width: 100%; max-width: 100%; overflow-x: auto; padding: 10px 0; -webkit-overflow-scrolling: touch; }
        .social-links { margin-top: 0; display: flex; justify-content: center; gap: 1rem; margin: 0; flex-wrap: wrap; padding: 0.25rem; min-width: min-content; }
        .social-link { color: white; text-decoration: none; display: inline-flex; align-items: center; gap: 0.25rem; padding: 0.35rem 0.75rem; border-radius: 6px; background: #2d3748; transition: all 0.3s ease; font-size: 0.85rem; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); white-space: nowrap; min-width: max-content; }
        .social-link:hover { background: #1e2837; transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15); }
        .bebell-footer { padding: 20px; }
        .bebell-footer p { align-items: center; text-align: center; font-size: 12px; margin: 0; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @media (max-width: 768px) { .container { padding: 1rem 1.5rem; } .controls-container { flex-direction: column; } .grid-container { grid-template-columns: 1fr; } .video-container { width: 95%; } .top-menu-content { padding: 0 1rem; } #topCtaBtn, #appBrandNameDisplay { display: none; } }
    </style>
</head>
<body>
    <div class="top-menu-bar">
        <div class="top-menu-content">
            <div class="logo-container">
                <img id="appLogo" src="https://bucket.mlcdn.com/a/3336/3336910/images/efd70bdbad93d8089105b519d602a6eccbfa84bf.png" alt="App Logo">
                <span id="appBrandNameDisplay"></span>
            </div>
            <div class="top-menu-actions">
                <div class="fab" id="settingsBtn" title="Settings"><i class="fas fa-cog"></i></div>
                <div class="fab" id="darkModeToggle" title="Toggle Theme"><i class="fas fa-moon"></i></div>
                <a href="#" id="topCtaBtn" class="btn" style="display: none;" target="_blank" rel="noopener noreferrer">Get Started</a>

            </div>
        </div>
    </div>
    
    <div id="notification" class="notification-banner"></div>

    <div class="container">
        <header class="header">
            <h1>YouTube Video Directory</h1>
            <p>A curated collection of hand-picked videos. Click to watch.</p>
        </header>

        

        <div class="controls-container">
            <div class="search-bar">
                <i class="fas fa-search"></i>
                <input type="text" id="searchInput" placeholder="Search videos by title...">
            </div>
            <button class="btn" id="adminLoginBtn"><i class="fas fa-user-shield"></i> Add New Entry</button>
        </div>

        <div class="tag-filters" id="tagFilters"></div>
        <div id="sections-container"></div>
    </div>


    

    <!-- Video Player Overlay -->
    <div class="overlay">
        <div class="video-container">
            <button class="close-btn"><i class="fas fa-times"></i></button>
            <div class="video-wrapper">
                <iframe src="" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
            </div>
            <a href="#" id="ctaButton" class="btn" target="_blank" rel="noopener noreferrer"></a>
            <footer class="footer">
                <div class="social-links-container">
                    <div class="social-links">
                        <a href="https://bebell-digital-solutions.github.io/checklist-creator/" class="social-link" rel="noopener noreferrer" target="_blank"><span>☑️</span> Checklist Creator</a>
                        <a href="https://bebell-digital-solutions.github.io/tasks-manager/en-v03" class="social-link" rel="noopener noreferrer" target="_blank"><span>🎯</span> Tasks Manager</a>
                        <a href="https://bebell-digital-solutions.github.io/bookmark-page/en-v03" class="social-link" rel="noopener noreferrer" target="_blank"><span>🔗</span> Links Manager</a>
                        <a href="https://bebell-digital-solutions.github.io/magic-toolbox-database/en-v03" class="social-link" rel="noopener noreferrer" target="_blank"><span>🧰</span> Magic Toolbox</a>
                        <a href="mailto:soporte@bebelldigitalsolutions.com" class="social-link" rel="noopener noreferrer" target="_blank"><span>📨</span> Tech Support</a>
                    </div>
                </div>
                <div class="bebell-footer">
                    <p>Powered with 💖 by <a href="https://bebelldigitalsolutions.com" class="bebell-link" target="_blank">Bebell Digital Solutions.</a><br><span id="copyrightYear"></span></p>
                </div>
            </footer>
        </div>
    </div>



    

    <!-- Admin Registration Modal -->
    <div id="registerModal" class="modal">
        <div class="modal-content">
            <h3>Let's Get You Started</h3>
            <p style="text-align: center; color: var(--text-light); margin-top: -1rem; margin-bottom: 1.5rem;">Create your admin account to manage the Help Center.</p>
            <form id="registerForm">
                <p id="register-error">An error occurred. Please try again.</p>
                <div class="profile-pic-uploader">
                    <label for="regProfilePic" class="profile-pic-preview" id="regProfilePicPreview">
                        <i class="fas fa-camera"></i>
                    </label>
                    <input type="file" id="regProfilePic" accept="image/*">
                    <label for="regProfilePic" class="btn" style="width:auto; padding: 8px 16px; font-size: 0.9rem;">Upload Photo</label>
                </div>
                <div class="form-group"><label for="regBrandName">Brand Name</label><input type="text" id="regBrandName" required></div>
                <div class="form-group"><label for="regUsername">Username</label><input type="text" id="regUsername" required></div>
                <div class="form-group"><label for="regPassword">Password</label><input type="password" id="regPassword" required></div>
                <div class="form-group">
                    <label for="regSheetId">Videos Google Sheet ID</label>
                    <input type="text" id="regSheetId" placeholder="From your spreadsheet URL" required>
                </div>
                <!-- NEW: Video Script URL field -->
                <div class="form-group">
                    <label for="regVideoScriptUrl">Video Script URL</label>
                    <input type="text" id="regVideoScriptUrl" placeholder="From your deployed Video Script" required>
                    <p class="field-instructions">
                        Need help? <a href="https://bebell-digital-solutions.github.io/magic-toolbox-database/en-v03" target="_blank">Follow our guide to get your Sheet ID and Script URL.</a>
                    </p>
                </div>
                <button type="submit" class="btn" style="width: 100%;">Create Admin Account</button>
            </form>
        </div>
    </div>





    
    <!-- Admin Login Modal -->
    <div id="loginModal" class="modal">
        <div class="modal-content">
            <span class="modal-close" data-modal-id="loginModal">&times;</span>
            <h3>Restricted Access</h3>
            <form id="loginForm">
                <p id="login-error">Invalid credentials. Please try again.</p>
                <div class="form-group"><label for="username">Username</label><input type="text" id="username" required></div>
                <div class="form-group"><label for="password">Password</label><input type="password" id="password" required></div>
                <button type="submit" class="btn" style="width: 100%;">Confirm Admin Access</button>
            </form>
        </div>
    </div>




    
    <!-- Settings Modal -->
    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <span class="modal-close" data-modal-id="settingsModal">&times;</span>
            <h3>Settings</h3>
            <div class="settings-profile">
                <img id="settingsProfilePic" src="https://placehold.co/100x100/2d3748/f7fafc?text=User" alt="Admin profile picture">
                <div>

                    
                    <h4>Welcome, <span id="settingsUsername">Admin</span>!</h4>
                    <p style="font-size: 0.9rem; color: var(--text-light); margin: 0;">You have access to all administrative features.</p>
                </div>
            </div>
            <div class="form-group">
                <label for="shareableUrl">Your Shareable Directory URL</label>
                <div class="share-url-container">
                    <input type="text" id="shareableUrl" readonly>
                    <button id="copyShareableUrlBtn" title="Copy URL"><i class="fas fa-copy"></i></button>
                </div>
                <div class="share-buttons" id="shareButtons"></div>
            </div>
            <div class="form-group">
                <label for="appBrandName">Brand Name</label>
                <input type="text" id="appBrandName">
            </div>
            <div class="form-group">
                <label for="appPrimaryColor">Primary Color</label>
                <input type="color" id="appPrimaryColor" style="width: 100%; height: 40px; padding: 0; border: none;">
            </div>
            <div class="form-group">
                <label for="appLogoFile">App Logo</label>
                <input type="file" id="appLogoFile" accept="image/*">
            </div>
            <div class="form-group">
                <label for="topCtaText">Top Bar CTA Text</label>
                <input type="text" id="topCtaText" placeholder="e.g., Get a Quote">
            </div>
            <div class="form-group">
                <label for="topCtaLink">Top Bar CTA Link</label>
                <input type="text" id="topCtaLink" placeholder="https://example.com">
            </div>
            <button id="saveSettingsBtn" class="btn" style="width: 100%;">Save Customizations</button>
            <hr style="margin: 1.5rem 0;">
            <div class="form-group">
                <label>Google Sheet Link</label>
                <a href="" id="googleSheetLink" target="_blank" rel="noopener noreferrer" class="btn" style="width:100%; background-color: var(--secondary);">Open Database Sheet</a>
            </div>
            <div class="form-group">
                <label>Danger Zone</label>
                <button id="deleteAllDataBtn" class="btn btn-danger" style="width: 100%;">Delete All Video Data</button>
                <p style="font-size: 0.8rem; color: var(--text-light); text-align: center; margin-top: 0.5rem;">This action is irreversible.</p>
            </div>
        </div>
    </div>



    

    <!-- Add/Edit Video Modal -->
    <div id="editCardModal" class="modal">
        <div class="modal-content">
            <span class="modal-close" data-modal-id="editCardModal">&times;</span>
            <h3 id="modalTitle">Add a New Video</h3>
            <form id="editCardForm">
                <input type="hidden" id="videoRowIndex">
                <div class="form-group"><label for="videoUrl">YouTube URL or Video ID</label><input type="text" id="videoUrl" required></div>
                <div class="form-group"><label for="videoTitle">Title</label><input type="text" id="videoTitle" required></div>
                <div class="form-group"><label for="videoDesc">Description</label><textarea id="videoDesc" required></textarea></div>
                <div class="form-group">
                    <label for="videoThumbnailFile">Custom Thumbnail (Optional)</label>
                    <input type="file" id="videoThumbnailFile" accept="image/*">
                </div>
                <div class="form-group"><label for="videoTags">Tags (comma separated)</label><input type="text" id="videoTags" placeholder="e.g., Job Search, Interview, Tips"></div>
                <div class="form-group">
                    <label for="videoCategory">Category / Section</label>
                    <input type="text" id="videoCategory" required>
                    <div class="recommendations" id="categoryRecommendations"></div>
                </div>
                <div class="form-group"><label for="videoCategoryDesc">Category Description</label><input type="text" id="videoCategoryDesc" required></div>
                <div class="form-group">
                    <label for="videoCtaText">CTA Button Text (Optional)</label>
                    <input type="text" id="videoCtaText" placeholder="e.g., Download Now, Learn More">
                    <div class="recommendations" id="ctaTextRecommendations"></div>
                </div>
                <div class="form-group"><label for="videoCtaLink">CTA Button Link (Optional)</label><input type="text" id="videoCtaLink" placeholder="https://example.com"></div>
                <button type="submit" class="btn" style="width: 100%;">Save Changes</button>
            </form>
        </div>
    </div>



    

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // --- CONFIGURATION ---
        const ADMIN_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxkFDul1ISUJ_VoT79NpYxCpEJIQOAwCf6JsTWWQlLmGaFv1AjkFs9BWtXhyWXdH-VCQA/exec'; // <-- IMPORTANT: REPLACE WITH YOUR *NEW* ADMIN SCRIPT URL

        // --- STATE ---
        let allVideos = [];
        let isAdminLoggedIn = false;
        let uniqueCategories = [];
        let appConfig = {};

        // --- DOM ELEMENTS ---
        const appLogo = document.getElementById('appLogo');
        const appBrandNameDisplay = document.getElementById('appBrandNameDisplay');
        const topCtaBtn = document.getElementById('topCtaBtn');
        const sectionsContainer = document.getElementById('sections-container');
        const overlay = document.querySelector('.overlay');
        const closeBtn = document.querySelector('.close-btn');
        const iframe = document.querySelector('iframe');
        const ctaButton = document.getElementById('ctaButton');
        const adminLoginBtn = document.getElementById('adminLoginBtn');
        const loginModal = document.getElementById('loginModal');
        const registerModal = document.getElementById('registerModal');
        const settingsModal = document.getElementById('settingsModal');
        const editCardModal = document.getElementById('editCardModal');
        const modalCloses = document.querySelectorAll('.modal-close');
        const loginForm = document.getElementById('loginForm');
        const registerForm = document.getElementById('registerForm');
        const editCardForm = document.getElementById('editCardForm');
        const searchInput = document.getElementById('searchInput');
        const tagFiltersContainer = document.getElementById('tagFilters');
        const darkModeToggle = document.getElementById('darkModeToggle');
        const settingsBtn = document.getElementById('settingsBtn');
        const notificationBanner = document.getElementById('notification');
        const copyrightYear = document.getElementById('copyrightYear');
        const deleteAllDataBtn = document.getElementById('deleteAllDataBtn');
        const googleSheetLink = document.getElementById('googleSheetLink');
        const regProfilePicInput = document.getElementById('regProfilePic');
        const regProfilePicPreview = document.getElementById('regProfilePicPreview');
        const videoThumbnailFileInput = document.getElementById('videoThumbnailFile');
        const settingsProfilePic = document.getElementById('settingsProfilePic');
        const settingsUsername = document.getElementById('settingsUsername');
        const shareableUrlInput = document.getElementById('shareableUrl');
        const copyShareableUrlBtn = document.getElementById('copyShareableUrlBtn');
        const shareButtonsContainer = document.getElementById('shareButtons');
        const appPrimaryColorInput = document.getElementById('appPrimaryColor');
        const appLogoFileInput = document.getElementById('appLogoFile');
        const appBrandNameInput = document.getElementById('appBrandName');
        const topCtaTextInput = document.getElementById('topCtaText');
        const topCtaLinkInput = document.getElementById('topCtaLink');
        const saveSettingsBtn = document.getElementById('saveSettingsBtn');
        const regVideoScriptUrlInput = document.getElementById('regVideoScriptUrl');

        // --- UTILITY FUNCTIONS ---
        const fileToBase64 = file => new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result);
            reader.onerror = reject;
        });

        function setupImagePreview(fileInput, previewContainer) {
            fileInput.addEventListener('change', () => {
                const file = fileInput.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        previewContainer.style.backgroundImage = `url(${e.target.result})`;
                        previewContainer.innerHTML = ''; // Remove icon
                    };
                    reader.readAsDataURL(file);
                }
            });
        }

        // --- CORE APP LOGIC ---
        function loadConfig() {
            const storedConfig = localStorage.getItem('helpCenterConfig');
            if (storedConfig) {
                appConfig = JSON.parse(storedConfig);
                return true;
            }
            return false;
        }

        function saveConfig() {
            localStorage.setItem('helpCenterConfig', JSON.stringify(appConfig));
        }

        // BUG FIX: Modified this function to accept a config object.
        // This allows applying branding from a shared link or fresh server data
        // without relying only on the global 'appConfig'.
        function applyCustomization(config = appConfig) {
            if (config.primaryColor) {
                document.documentElement.style.setProperty('--primary', config.primaryColor);
            }
            if (config.logoUrl) {
                appLogo.src = config.logoUrl;
            }
            if (config.brandName) {
                appBrandNameDisplay.textContent = config.brandName;
            }
            if (config.topCtaText && config.topCtaLink) {
                topCtaBtn.textContent = config.topCtaText;
                topCtaBtn.href = config.topCtaLink;
                topCtaBtn.style.display = 'flex';
            } else {
                topCtaBtn.style.display = 'none';
            }
        }
        
        async function fetchVideos() {
            const urlParams = new URLSearchParams(window.location.search);
            const userId = urlParams.get('user');
            let videoScriptUrl = appConfig.videoScriptUrl;

            if (userId) {
                // If viewing a shared link, fetch the specific user's branding and script URL
                try {
                    const response = await fetch(`${ADMIN_SCRIPT_URL}?action=getUserData&userId=${userId}`);
                    const userData = await response.json();
                    if (userData.status === 'success' && userData.data) {
                        videoScriptUrl = userData.data.videoScriptUrl;
                        // BUG FIX: Pass the fetched user data directly to apply their specific branding.
                        applyCustomization(userData.data); 
                    } else {
                        throw new Error(userData.message || 'Could not find user data.');
                    }
                } catch (error) {
                     sectionsContainer.innerHTML = `<p style="text-align:center; color: red;">${error.message}</p>`;
                     return;
                }
            }
            
            if (!videoScriptUrl) {
                if(!userId) openModal(registerModal);
                return;
            }

            sectionsContainer.innerHTML = `<p style="text-align:center;">Loading videos...</p>`;
            try {
                // Use the determined video script URL (either the admin's or the shared user's)
                const response = await fetch(`${videoScriptUrl}?user=${userId || appConfig.userId}`);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();
                
                if (data.error) { throw new Error(data.error); }
                if (data.status === 'pending') {
                    document.body.innerHTML = `<div style="text-align: center; padding: 4rem; font-size: 1.2rem; color: var(--text-light);">Your Directory is waiting for approval. If this persists, please contact Customer Support.</div>`;
                    return;
                }

                allVideos = data;
                uniqueCategories = [...new Set(allVideos.map(v => v.category).filter(Boolean))].sort();
                renderContent();
            } catch (error) {
                console.error('Error fetching videos:', error);
                sectionsContainer.innerHTML = `<p style="text-align:center; color: red;">Failed to load video data. Please check your Video Script URL and Sheet permissions. Error: ${error.message}</p>`;
            }
        }

        function renderContent() {
            const searchTerm = searchInput.value.toLowerCase();
            const activeTag = document.querySelector('.tag-filter.active')?.dataset.tag || 'all';
            const filteredVideos = allVideos.filter(video => {
                const titleMatch = video.title && video.title.toLowerCase().includes(searchTerm);
                const tagMatch = activeTag === 'all' || (video.tags && video.tags.includes(activeTag));
                return titleMatch && tagMatch;
            });
            const groupedByCategory = filteredVideos.reduce((acc, video) => {
                const category = video.category || 'Uncategorized';
                if (!acc[category]) {
                    acc[category] = { description: video.categorydescription || '', videos: [] };
                }
                acc[category].videos.push(video);
                return acc;
            }, {});
            sectionsContainer.innerHTML = '';
            if (Object.keys(groupedByCategory).length === 0) {
                sectionsContainer.innerHTML = `<p style="text-align:center;">No videos found.</p>`;
            }
            for (const categoryName in groupedByCategory) {
                const sectionData = groupedByCategory[categoryName];
                const section = document.createElement('section');
                section.className = 'video-section';
                const gridContainer = document.createElement('div');
                gridContainer.className = 'grid-container';
                sectionData.videos.forEach(video => gridContainer.appendChild(createCard(video)));
                section.innerHTML = `<div class="section-header"><h2>${categoryName}</h2><p>${sectionData.description}</p></div>`;
                section.appendChild(gridContainer);
                sectionsContainer.appendChild(section);
            }
            renderTagFilters();
        }

        function createCard(video) {
            const card = document.createElement('div');
            card.className = 'card';
            card.dataset.rowIndex = video.rowindex;
            const thumbnailUrl = video.thumbnail || `https://i.ytimg.com/vi/${video.id}/hqdefault.jpg`;
            const tagsHtml = video.tags ? video.tags.map(tag => `<span class="tag">${tag}</span>`).join('') : '';
            card.innerHTML = `
                <div class="card-admin-controls">
                    <button class="admin-btn edit-btn" title="Edit"><i class="fas fa-pencil-alt"></i></button>
                    <button class="admin-btn delete-btn" title="Delete"><i class="fas fa-trash-alt"></i></button>
                </div>
                <div class="thumbnail" data-video-id="${video.id}" data-row-index="${video.rowindex}">
                    <img src="${thumbnailUrl}" alt="${video.title}" onerror="this.onerror=null;this.src='https://placehold.co/600x400/2d3748/f7fafc?text=Video+Not+Found';">
                    <div class="play-button"><i class="fas fa-play"></i></div>
                </div>
                <div class="content">
                    <h3 class="title">${video.title || 'No Title'}</h3>
                    <p class="description">${video.description || ''}</p>
                    <div class="tags">${tagsHtml}</div>
                </div>`;
            return card;
        }
        
        function renderTagFilters() {
            const allTags = [...new Set(allVideos.flatMap(v => v.tags || []))].filter(Boolean).sort();
            const currentActiveTag = document.querySelector('.tag-filter.active')?.dataset.tag || 'all';
            tagFiltersContainer.innerHTML = `<button class="tag-filter ${currentActiveTag === 'all' ? 'active' : ''}" data-tag="all">Show All</button>`;
            const TAG_LIMIT = 10;
            allTags.forEach((tag, index) => {
                const button = document.createElement('button');
                button.className = 'tag-filter';
                if (currentActiveTag === tag) button.classList.add('active');
                if (index >= TAG_LIMIT) {
                    button.classList.add('extra-tag');
                    button.style.display = 'none';
                }
                button.dataset.tag = tag;
                button.textContent = tag;
                tagFiltersContainer.appendChild(button);
            });
            if (allTags.length > TAG_LIMIT) {
                const showMoreBtn = document.createElement('button');
                showMoreBtn.id = 'showMoreTags';
                showMoreBtn.textContent = 'Show More...';
                showMoreBtn.onclick = (e) => {
                    const extraTags = tagFiltersContainer.querySelectorAll('.extra-tag');
                    const isHidden = extraTags[0].style.display === 'none';
                    extraTags.forEach(tag => {
                        tag.style.display = isHidden ? 'inline-block' : 'none';
                    });
                    e.target.textContent = isHidden ? 'Show Less...' : 'Show More...';
                };
                tagFiltersContainer.appendChild(showMoreBtn);
            }
        }
        
        async function manageVideo(action, data) {
            showNotification(`Processing request...`, 'info');
            try {
                const response = await fetch(appConfig.videoScriptUrl, {
                    method: 'POST',
                    mode: 'cors',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify({ action, userId: appConfig.userId, data }),
                });
                if (!response.ok) throw new Error(`Server responded with status: ${response.status}`);
                const result = await response.json();
                if (result.status === 'success') {
                    showNotification(`${action.charAt(0).toUpperCase() + action.slice(1)} successful!`, 'success');
                    await fetchVideos();
                } else {
                    throw new Error(result.message || 'The script reported an unknown error.');
                }
            } catch (error) {
                console.error(`Error during ${action}:`, error);
                showNotification(`Error: Could not complete ${action}. Check console.`, 'error');
            }
        }

        function renderRecommendations() {
            const categoryRecsContainer = document.getElementById('categoryRecommendations');
            categoryRecsContainer.innerHTML = '';
            uniqueCategories.forEach(category => {
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'rec-btn';
                btn.textContent = category;
                btn.onclick = () => {
                    document.getElementById('videoCategory').value = category;
                    const existingVideo = allVideos.find(v => v.category === category);
                    if (existingVideo) {
                         document.getElementById('videoCategoryDesc').value = existingVideo.categorydescription;
                    }
                };
                categoryRecsContainer.appendChild(btn);
            });
            const ctaRecsContainer = document.getElementById('ctaTextRecommendations');
            ctaRecsContainer.innerHTML = '';
            const defaultCtaTexts = ['Learn More', 'Download Now', 'Sign Up', 'Get Started', 'View Details', 'Contact Us', 'Get a Quote', 'Book a Call', 'Buy Now'];
            defaultCtaTexts.forEach(text => {
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'rec-btn';
                btn.textContent = text;
                btn.onclick = () => { document.getElementById('videoCtaText').value = text; };
                ctaRecsContainer.appendChild(btn);
            });
        }

        function openEditModal(video = null) {
            editCardForm.reset();
            const modalTitle = document.getElementById('modalTitle');
            if (video) {
                modalTitle.textContent = 'Edit Video';
                document.getElementById('videoRowIndex').value = video.rowindex;
                document.getElementById('videoUrl').value = video.url;
                document.getElementById('videoTitle').value = video.title;
                document.getElementById('videoDesc').value = video.description;
                document.getElementById('videoTags').value = video.tags ? video.tags.join(', ') : '';
                document.getElementById('videoCategory').value = video.category;
                document.getElementById('videoCategoryDesc').value = video.categorydescription;
                document.getElementById('videoCtaText').value = video.ctatext || '';
                document.getElementById('videoCtaLink').value = video.ctalink || '';
            } else {
                modalTitle.textContent = 'Add a New Video';
                document.getElementById('videoRowIndex').value = '';
            }
            renderRecommendations();
            openModal(editCardModal);
        }
        
        // --- EVENT LISTENERS ---
        sectionsContainer.addEventListener('click', function(e) {
            const thumbnail = e.target.closest('.thumbnail');
            const editBtn = e.target.closest('.edit-btn');
            const deleteBtn = e.target.closest('.delete-btn');
            if (thumbnail) {
                const video = allVideos.find(v => v.rowindex == thumbnail.dataset.rowIndex);
                openOverlay(video);
            } else if (editBtn) {
                const card = e.target.closest('.card');
                const video = allVideos.find(v => v.rowindex == card.dataset.rowIndex);
                openEditModal(video);
            } else if (deleteBtn) {
                if (confirm('Are you sure you want to delete this video? This action is permanent.')) {
                    const card = e.target.closest('.card');
                    manageVideo('delete', { rowIndex: card.dataset.rowIndex });
                }
            }
        });

        adminLoginBtn.addEventListener('click', () => {
            if (isAdminLoggedIn) openEditModal();
            else openModal(loginModal);
        });

        loginForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            if (username === appConfig.adminUser && password === appConfig.adminPass) {
                isAdminLoggedIn = true;
                document.body.classList.add('admin-logged-in');
                adminLoginBtn.innerHTML = `<i class="fas fa-plus"></i> Add New Video`;
                closeModal(loginModal);
                loginForm.reset();
                document.getElementById('login-error').style.display = 'none';
                showNotification('Admin login successful!', 'success');
            } else {
                document.getElementById('login-error').style.display = 'block';
            }
        });
        
        registerForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            showNotification('Registering Admin...', 'info');
            const brandName = document.getElementById('regBrandName').value;
            const username = document.getElementById('regUsername').value;
            const password = document.getElementById('regPassword').value;
            const sheetId = document.getElementById('regSheetId').value;
            const videoScriptUrl = regVideoScriptUrlInput.value;
            const profilePicFile = regProfilePicInput.files[0];
            
            let profilePicData = {};
            if (profilePicFile) {
                profilePicData = {
                    base64: await fileToBase64(profilePicFile),
                    type: profilePicFile.type,
                    name: profilePicFile.name
                };
            }

            try {
                const response = await fetch(ADMIN_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'cors',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify({
                        action: 'registerAdmin',
                        data: { brandName, username, password, sheetId, videoScriptUrl, profilePic: profilePicData }
                    }),
                });
                if (!response.ok) throw new Error(`Server responded with status: ${response.status}`);
                const result = await response.json();
                if (result.status === 'success') {
                    appConfig = {
                        adminUser: username,
                        adminPass: password,
                        sheetId: sheetId,
                        userId: result.userId,
                        brandName: brandName,
                        videoScriptUrl: videoScriptUrl,
                        profilePicUrl: result.profilePicUrl || ''
                    };
                    saveConfig();
                    showNotification('Registration Successful!', 'success');
                    closeModal(registerModal);
                    location.reload();
                } else {
                    throw new Error(result.message || 'Registration failed.');
                }
            } catch (error) {
                console.error('Registration Error:', error);
                document.getElementById('register-error').textContent = error.message;
                document.getElementById('register-error').style.display = 'block';
            }
        });

        editCardForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            const rowIndex = document.getElementById('videoRowIndex').value;
            const videoId = getYouTubeID(document.getElementById('videoUrl').value);
            if (!videoId) {
                alert('Invalid YouTube URL or Video ID.'); return;
            }

            const thumbnailFile = videoThumbnailFileInput.files[0];
            let thumbnailData = {};
            if (thumbnailFile) {
                showNotification('Uploading thumbnail...', 'info');
                thumbnailData = {
                    base64: await fileToBase64(thumbnailFile),
                    type: thumbnailFile.type,
                    name: thumbnailFile.name
                };
            }

            const videoData = {
                title: document.getElementById('videoTitle').value,
                description: document.getElementById('videoDesc').value,
                url: document.getElementById('videoUrl').value,
                id: videoId,
                thumbnailData: thumbnailData,
                tags: document.getElementById('videoTags').value,
                category: document.getElementById('videoCategory').value,
                categoryDescription: document.getElementById('videoCategoryDesc').value,
                ctaText: document.getElementById('videoCtaText').value,
                ctaLink: document.getElementById('videoCtaLink').value,
            };
            const action = rowIndex ? 'update' : 'create';
            if (action === 'update') videoData.rowIndex = rowIndex;
            manageVideo(action, videoData);
            closeModal(editCardModal);
        });
        
        settingsBtn.addEventListener('click', () => {
            if (isAdminLoggedIn) {
                googleSheetLink.href = `https://docs.google.com/spreadsheets/d/${appConfig.sheetId}/edit`;
                settingsUsername.textContent = appConfig.adminUser;
                if (appConfig.profilePicUrl) settingsProfilePic.src = appConfig.profilePicUrl;
                
                const shareableUrl = `${window.location.origin}${window.location.pathname}?user=${appConfig.userId}`;
                shareableUrlInput.value = shareableUrl;

                appBrandNameInput.value = appConfig.brandName || '';
                appPrimaryColorInput.value = appConfig.primaryColor || '#DF1783';
                topCtaTextInput.value = appConfig.topCtaText || '';
                topCtaLinkInput.value = appConfig.topCtaLink || '';
                
                shareButtonsContainer.innerHTML = '';
                const encodedUrl = encodeURIComponent(shareableUrl);
                const shareText = encodeURIComponent(`Check out my Help Center: ${appConfig.brandName}`);
                const socials = {
                    whatsapp: `https://wa.me/?text=${shareText}%20${encodedUrl}`,
                    email: `mailto:?subject=${shareText}&body=${encodedUrl}`,
                    facebook: `https://www.facebook.com/sharer/sharer.php?u=${encodedUrl}`,
                    twitter: `https://twitter.com/intent/tweet?text=${shareText}&url=${encodedUrl}`,
                    linkedin: `https://www.linkedin.com/shareArticle?mini=true&url=${encodedUrl}&title=${shareText}`
                };
                for (const [name, link] of Object.entries(socials)) {
                    const a = document.createElement('a');
                    a.href = link; a.target = '_blank'; a.rel = 'noopener noreferrer'; a.className = 'share-btn';
                    a.innerHTML = `<i class="fab fa-${name}"></i>`;
                    shareButtonsContainer.appendChild(a);
                }

                openModal(settingsModal);
            } else {
                showNotification('You must be logged in as an admin to access settings.', 'error');
            }
        });

        saveSettingsBtn.addEventListener('click', async () => {
            showNotification('Saving settings...', 'info');
            appConfig.brandName = appBrandNameInput.value;
            appConfig.primaryColor = appPrimaryColorInput.value;
            appConfig.topCtaText = topCtaTextInput.value;
            appConfig.topCtaLink = topCtaLinkInput.value;
            
            const logoFile = appLogoFileInput.files[0];
            let logoData = {};
            if (logoFile) {
                logoData = {
                    base64: await fileToBase64(logoFile),
                    type: logoFile.type,
                    name: logoFile.name
                };
            }

            try {
                 const response = await fetch(ADMIN_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'cors',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify({
                        action: 'updateSettings',
                        data: { 
                            userId: appConfig.userId,
                            brandName: appConfig.brandName,
                            primaryColor: appConfig.primaryColor,
                            topCtaText: appConfig.topCtaText,
                            topCtaLink: appConfig.topCtaLink,
                            logoData: logoData
                        }
                    }),
                });
                if (!response.ok) throw new Error(`Server responded with status: ${response.status}`);
                const result = await response.json();
                if (result.status === 'success') {
                    if(result.logoUrl) appConfig.logoUrl = result.logoUrl;
                    saveConfig();
                    applyCustomization();
                    showNotification('Settings saved successfully!', 'success');
                    closeModal(settingsModal);
                } else {
                    throw new Error(result.message || 'Failed to save settings.');
                }
            } catch (error) {
                console.error('Settings Error:', error);
                showNotification('Error saving settings. Check console.', 'error');
            }
        });

        deleteAllDataBtn.addEventListener('click', () => {
            const confirmation = prompt("This will delete all video data permanently. This action cannot be undone. Type 'DELETE' to confirm.");
            if (confirmation === 'DELETE') {
                manageVideo('deleteAllData', {});
                closeModal(settingsModal);
            } else {
                showNotification('Deletion cancelled.', 'info');
            }
        });

        copyShareableUrlBtn.addEventListener('click', () => {
            shareableUrlInput.select();
            document.execCommand('copy');
            showNotification('Shareable URL copied to clipboard!', 'success');
        });

        searchInput.addEventListener('input', renderContent);
        tagFiltersContainer.addEventListener('click', function(e) {
            if (e.target.classList.contains('tag-filter')) {
                document.querySelector('.tag-filter.active')?.classList.remove('active');
                e.target.classList.add('active');
                renderContent();
            }
        });

        modalCloses.forEach(btn => btn.addEventListener('click', () => closeModal(document.getElementById(btn.dataset.modalId))));
        darkModeToggle.addEventListener('click', toggleDarkMode);
        overlay.addEventListener('click', (e) => e.target === overlay && closeOverlay());
        document.addEventListener('keydown', (e) => e.key === 'Escape' && closeOverlay());
        closeBtn.addEventListener('click', closeOverlay);
        
        setupImagePreview(regProfilePicInput, regProfilePicPreview);

        // --- UTILITY FUNCTIONS (continued) ---
        function openOverlay(video) {
            if (!video) return;
            iframe.src = `https://www.youtube.com/embed/${video.id}?autoplay=1`;
            if (video.ctalink && video.ctatext) {
                ctaButton.href = video.ctalink;
                ctaButton.textContent = video.ctatext;
                ctaButton.style.display = 'block';
            } else {
                ctaButton.style.display = 'none';
            }
            overlay.classList.add('active');
            document.body.style.overflow = 'hidden';
        }
        function closeOverlay() {
            overlay.classList.remove('active');
            iframe.src = '';
            document.body.style.overflow = 'auto';
            ctaButton.style.display = 'none';
        }
        function openModal(modal) { modal.classList.add('active'); }
        function closeModal(modal) { modal.classList.remove('active'); }
        function getYouTubeID(url) { const regex = /(?:https?:\/\/)?(?:www\.)?(?:youtube\.com\/(?:[^\/\n\s]+\/\S+\/|(?:v|e(?:mbed)?)\/|\S*?[?&]v=)|youtu\.be\/)([a-zA-Z0-9_-]{11})/; const match = url.match(regex); return match ? match[1] : (url.length === 11 ? url : null); }
        function showNotification(message, type = 'info') {
            notificationBanner.textContent = message;
            notificationBanner.style.backgroundColor = type === 'error' ? '#e53e3e' : type === 'success' ? 'var(--accent)' : '#3498db';
            notificationBanner.classList.add('show');
            setTimeout(() => notificationBanner.classList.remove('show'), 3000);
        }
        function toggleDarkMode() { document.body.classList.toggle('dark-mode'); const icon = darkModeToggle.querySelector('i'); icon.className = document.body.classList.contains('dark-mode') ? 'fas fa-sun' : 'fas fa-moon'; }

        // --- INITIALIZATION ---
        async function initializeApp() {
            copyrightYear.textContent = `© ${new Date().getFullYear()} • All rights reserved.`;
            const urlParams = new URLSearchParams(window.location.search);
            const isSharedLink = urlParams.has('user');

            if (isSharedLink) {
                // For a shared link, we don't need the admin's local config.
                // We just fetch the specific user's data and videos.
                await fetchVideos();
            } else {
                // This is the admin's view.
                if (loadConfig()) {
                    // BUG FIX: Fetch the latest user data from the server to ensure branding (like the logo) is up-to-date.
                    try {
                        const response = await fetch(`${ADMIN_SCRIPT_URL}?action=getUserData&userId=${appConfig.userId}`);
                        const userData = await response.json();
                        if (userData.status === 'success' && userData.data) {
                            // Update local config with fresh data from server
                            Object.assign(appConfig, userData.data);
                            saveConfig(); // Save the fresh config back to localStorage
                        }
                    } catch (error) {
                        console.error("Could not refresh admin data:", error);
                        // Continue with local data if refresh fails
                    }
                    
                    applyCustomization(); // Apply the potentially updated config
                    await fetchVideos(); // Fetch videos using the config
                } else {
                    // No config found, must be a new admin.
                    openModal(registerModal);
                }
            }
        }

        initializeApp();
    });
    </script>
</body>
</html>
